<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=content-security-policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self'; img-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/; script-src 'self' 'unsafe-inline' https://www.google-analytics.com https://cdn.jsdelivr.net/; prefetch-src 'self'; connect-src 'self' https://www.google-analytics.com;"><meta name=author content="Brian Osborne"><meta name=description content="In case you&rsquo;ve been living under a rock for the past two years: Drupal 7 is known to use quite a bit of PHP memory everytime a page is loaded. I won&rsquo;t get into anything why that is and why it&rsquo;s such a big jump from Drupal 6 (I&rsquo;m in no position to comment on that), but what you need to know is that Drupal 7 can easily use 40-50 MB per page load for a small to mid size website, and much much more for larger websites."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Determine PHP memory usage for anonymous users"><meta name=twitter:description content="In case you&rsquo;ve been living under a rock for the past two years: Drupal 7 is known to use quite a bit of PHP memory everytime a page is loaded. I won&rsquo;t get into anything why that is and why it&rsquo;s such a big jump from Drupal 6 (I&rsquo;m in no position to comment on that), but what you need to know is that Drupal 7 can easily use 40-50 MB per page load for a small to mid size website, and much much more for larger websites."><meta property="og:title" content="Determine PHP memory usage for anonymous users"><meta property="og:description" content="In case you&rsquo;ve been living under a rock for the past two years: Drupal 7 is known to use quite a bit of PHP memory everytime a page is loaded. I won&rsquo;t get into anything why that is and why it&rsquo;s such a big jump from Drupal 6 (I&rsquo;m in no position to comment on that), but what you need to know is that Drupal 7 can easily use 40-50 MB per page load for a small to mid size website, and much much more for larger websites."><meta property="og:type" content="article"><meta property="og:url" content="http://www.example.com/blog/determine-php-memory-usage-for-anonymous-users/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2012-02-16T00:00:00-05:00"><meta property="article:modified_time" content="2012-02-16T00:00:00-05:00"><title>Determine PHP memory usage for anonymous users · Brian Osborne</title><link rel=canonical href=http://www.example.com/blog/determine-php-memory-usage-for-anonymous-users/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.531b74bda2bd1e0562323a98f617314ce9c7cc8c8cffbc609f5f690abf6ac68c.css integrity="sha256-Uxt0vaK9HgViMjqY9hcxTOnHzIyM/7xgn19pCr9qxow=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.002ee2378e14c7a68f1f0a53d9694ed252090987c4e768023fac694a4fc5f793.css integrity="sha256-AC7iN44Ux6aPHwpT2WlO0lIJCYfE52gCP6xpSk/F95M=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><meta name=generator content="Hugo 0.82.1"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Brian Osborne</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=http://www.example.com/blog/determine-php-memory-usage-for-anonymous-users/>Determine PHP memory usage for anonymous users</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2012-02-16T00:00:00-05:00>February 16, 2012</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
4-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/drupal-planet/>Drupal Planet</a></span></div></div></header><div><p>In case you&rsquo;ve been living under a rock for the past two years: Drupal 7 is known to use quite a bit of PHP memory everytime a page is loaded. I won&rsquo;t get into anything why that is and why it&rsquo;s such a big jump from Drupal 6 (I&rsquo;m in no position to comment on that), but what you need to know is that Drupal 7 can easily use 40-50 MB per page load for a small to mid size website, and much much more for larger websites. Turn on some sort of PHP opcode cache like APC and you can probably get that small to mid site down to 10MB of usage or lower. With this number in mind, as well as an idea of how much traffic your site will see per day, you can come up with a ballpark server specification that will handle your website.</p><p>How do I know that? The Devel module of course! There&rsquo;s an option in the settings for Devel that will report to you (at the very bottom of your page) the total memory that Drupal used from bootstrap until the page was completely built and served to the browser. If you&rsquo;ve never done this before, go try it out for yourself. There are also a bunch of other performance reporting options in there that are worth playing around with as well.</p><p>But let&rsquo;s get back to the memory usage itself&mldr; that 10MB per page load I was talking about actually only relates to <em>authenticated</em> users on your Drupal site. It&rsquo;s most likely that the vast majority of your visitors will be anonymous, non logged in users. This is very important to understand. If you are building a content-driven website with no community portal or user login area, that 10MB is not an accurate representation of the memory usage of your website&mldr; What you really want to know is how much memory Drupal uses when serving pages for <em>anonymous</em> users.</p><p>Assuming you have anonymous page caching turned on (you do, <em>right</em>?), Drupal will use far less memory and system resources to build page requests for anonymous users than it does for authenticated users. Cool, so let&rsquo;s just go to the Devel permissions and turn give anonymous users access to see devel info.</p><p>Nope. For reasons I don&rsquo;t completely understand at the moment (I&rsquo;m not an expert on Drupal page caching), the devel summary information is not printed out for cached pages. So I did some exploring and found the function in devel.module that gathers the memory usage and prints it out. Turns out the code is still executed, but the text it generates is not printed out. For Drupal 7, the code is in the function &ldquo;devel_shutdown_memory&rdquo; on the file devel.module. This is a sort of helper function that is called when Drupal is just about completely done doing it&rsquo;s thing, and all it&rsquo;s code has been processed and memory has been used. Here&rsquo;s that function:</p><pre><code>function devel_shutdown_memory() {
  global $memory_init;

  if (variable_get('dev_mem', FALSE)) {
    $memory_shutdown = memory_get_usage();
    $args = array('@memory_boot' =&amp;gt; round($memory_init / 1024 / 1024, 2), '@memory_shutdown' =&amp;gt; round($memory_shutdown / 1024 / 1024, 2), '@memory_peak' =&amp;gt; round(memory_get_peak_usage(TRUE) / 1024 / 1024, 2));
    $msg = ' Memory used at: devel_boot()=&lt;strong&gt;@memory_boot&lt;/strong&gt; MB, devel_shutdown()=&lt;strong&gt;@memory_shutdown&lt;/strong&gt; MB, PHP peak=&lt;strong&gt;@memory_peak&lt;/strong&gt; MB.';
    // theme() may not be available. not t() either.
    return t_safe($msg, $args);
  }
}
</code></pre><p><strong>This function is still called for anonymous page views</strong>, so this is where we will put our dirty hack. That return statement sends off the built string with the memory usage in it which eventually gets printed out; but like I said, this is not visible for cached pages. Instead, lets write the memory shutdown variable the PHP error log. This is just a temporary adjustment to the code so we can get reports of how much memory Drupal is using. Once we get what info we need, we can just remove the error_log line.</p><p>Add this just before the return statement:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>error_log(round($memory_shutdown / 1024 / 1024, 2));
</code></pre></div><p>Then you can tail your error log as you browse your website as an anonymous user. Now you&rsquo;ll be able to see the memory usage of anonymous page visits on various pages of your site.</p><p>I wrote this blog post because over the summer I was unable to find any information on how to easily find memory usage for anonymous page views, and I was in a situation where I needed to know that. Working on a site where memory usage for logged in users (with APC) was reaching 30MB, I was happy to find out that anonymous users were only using 4-6MB. This allowed me to tweak Apache&rsquo;s settings and find a good cloud hosting environment for the website.</p></div><footer><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//bkosborne.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></section></div><footer class=footer><section class=container>©
2010 -
2022
Brian Osborne
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.39a51230dce2ac866c049b52573e38bf60666af4bc63c1bdf203b9b2d95b1cd6.js integrity="sha256-OaUSMNzirIZsBJtSVz44v2BmavS8Y8G98gO5stlbHNY="></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "bd8a23ecd0e34c58a89099ab25d009a"}'></script></body></html>