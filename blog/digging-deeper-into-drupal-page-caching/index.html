<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=Content-Security-Policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self'; img-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/; script-src 'self' 'unsafe-inline' https://www.google-analytics.com https://cdn.jsdelivr.net/; prefetch-src 'self'; connect-src 'self' https://www.google-analytics.com;"><meta name=author content="Brian Osborne"><meta name=description content="I&rsquo;ve been away from full time Drupal development for a couple of years and have recently returned, this time making a commitment improve my understanding of core. There&rsquo;s a lot of information out there on Drupal caching, but I found much of it to be fragmented and outdated (Drupal 6). I wanted to provide a more comprehensive look at Drupal 7&rsquo;s core caching, explaining how some of this stuff is actually working under the hood."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Digging Deeper into Drupal Page Caching"><meta name=twitter:description content="I&rsquo;ve been away from full time Drupal development for a couple of years and have recently returned, this time making a commitment improve my understanding of core. There&rsquo;s a lot of information out there on Drupal caching, but I found much of it to be fragmented and outdated (Drupal 6). I wanted to provide a more comprehensive look at Drupal 7&rsquo;s core caching, explaining how some of this stuff is actually working under the hood."><meta property="og:title" content="Digging Deeper into Drupal Page Caching"><meta property="og:description" content="I&rsquo;ve been away from full time Drupal development for a couple of years and have recently returned, this time making a commitment improve my understanding of core. There&rsquo;s a lot of information out there on Drupal caching, but I found much of it to be fragmented and outdated (Drupal 6). I wanted to provide a more comprehensive look at Drupal 7&rsquo;s core caching, explaining how some of this stuff is actually working under the hood."><meta property="og:type" content="article"><meta property="og:url" content="http://bkosborne.com/blog/digging-deeper-into-drupal-page-caching/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2013-12-16T00:00:00+00:00"><meta property="article:modified_time" content="2013-12-16T00:00:00+00:00"><title>Digging Deeper into Drupal Page Caching · Brian Osborne
</title><link rel=canonical href=http://bkosborne.com/blog/digging-deeper-into-drupal-page-caching/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.d9fddbffe6f27e69985dc5fe0471cdb0e57fbf4775714bc3d847accb08f4a1f6.css integrity="sha256-2f3b/+byfmmYXcX+BHHNsOV/v0d1cUvD2Eesywj0ofY=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.002ee2378e14c7a68f1f0a53d9694ed252090987c4e768023fac694a4fc5f793.css integrity="sha256-AC7iN44Ux6aPHwpT2WlO0lIJCYfE52gCP6xpSk/F95M=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><meta name=generator content="Hugo 0.124.1"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Brian Osborne
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=http://bkosborne.com/blog/digging-deeper-into-drupal-page-caching/>Digging Deeper into Drupal Page Caching</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2013-12-16T00:00:00Z>December 16, 2013
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
14-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/drupal-planet/>Drupal Planet</a></span></div></div></header><div><p>I&rsquo;ve been away from full time Drupal development for a couple of years and have recently returned, this time making a commitment improve my understanding of core. There&rsquo;s a lot of information out there on Drupal caching, but I found much of it to be fragmented and outdated (Drupal 6). I wanted to provide a more comprehensive look at Drupal 7&rsquo;s core caching, explaining how some of this stuff is actually working under the hood.</p><h2 id=measuring-performance>Measuring Performance
<a class=heading-link href=#measuring-performance><i class="fa fa-link" aria-hidden=true></i></a></h2><p>Before we get started, it&rsquo;s worth discussing how you can measure the performance of your site so you can see for yourself the impact caching will have. The easiest way to do this is to use the <a href=http://drupal.org/project/devel>devel</a> module, which most Drupal developers should already be familiar with. Among other useful features, this module allows you to print out the time it took to render the page and the total memory usage of PHP to serve a page request.</p><p>Devel will reveal that for a Drupal 7 site with a couple dozen contrib modules enabled and no caching enabled, about 30-50 MB of memory will be used to serve each page request. It will also show that page execution time (time it took to render the HTML) is around 400-500ms.</p><p>Generally, those numbers are not performant and you won&rsquo;t be serving a lot of simultaneous page requests before bringing your server down. You should always be concerned with optimizing your site to increase page response time and reduce memory usage. Even if you&rsquo;re not developing for high traffic sites, you want every visitor to have the best experience possible.</p><p>Another useful and easy to use tool is your browser&rsquo;s developer tools. Years ago you had to use FireBug w/ FireFox, but most of the FireBug features are now built into the dev tools native to all the popular browsers, including Internet Explorer (which isn&rsquo;t so bad these days!).</p><p>I use Chrome, and the rapid release cycle for the browser means the packaged dev tools suite is very robust and constantly improving. For looking at performance of your site, dev tools is useful in showing you the number of HTTP requests made (the fewer the better), the time it took the server to respond to these requests, and the HTTP headers sent and received for each request. I encourage you to explore the dev tools and discover their usefulness.</p><h2 id=how-drupal-sets-cached-pages>How Drupal sets cached pages
<a class=heading-link href=#how-drupal-sets-cached-pages><i class="fa fa-link" aria-hidden=true></i></a></h2><p>Page caching is when Drupal takes the <em>entire rendered output</em> of a page and stores it in the database (or another cache store; defaults to the database). Pages will only be cached for anonymous traffic and for users that don&rsquo;t have session data, like items in a shopping cart. This is because if dynamic data like a shopping cart or a &ldquo;Welcome Brian&rdquo; message was cached, it would screw things up when that cached page was delivered for other anonymous traffic.</p><p>We need to look into how Drupal loads up every time a page is requested. It&rsquo;s not as complicated as you may think, and it&rsquo;s fairly straight forward to follow. This process is called &ldquo;bootstrapping&rdquo; and is split into many different phases. Each phase loads a different part of Drupal, progressively loading more core API functions, theme code, and module code.</p><p>If we look at <code>index.php</code>, you can see a call to <code>drupal_bootstrap(DRUPAL_BOOTSTRAP_FULL);</code>. If you take a look at the <a href=https://api.drupal.org/api/drupal/includes%21bootstrap.inc/function/drupal_bootstrap/7>the code</a> for <code>drupal_bootstrap</code>, you can see each of the 8 phases and get an idea of what each is doing. Drupal&rsquo;s index.php passes in <code>DRUPAL_BOOTSTRAP_FULL</code>, which indicates that every single phase should be executed to load the entire environment. Each phase is loaded in succession. Also of note are the comments for this function, which indicate how you could call <code>drupal_bootstrap</code> yourself to load the Drupal environment for a custom script (very useful!).</p><p>So how does page caching tie into this? Well, more time, memory, and CPU is used for each bootstrap function that is loaded. Under normal circumstances, each phase of the process is needed so that the page can be properly rendered. However, when page caching is turned on, and the page is eligible to be cached, Drupal will store the rendered page output via the <a href=https://api.drupal.org/api/drupal/includes%21common.inc/function/drupal_page_set_cache/7>drupal_page_set_cache</a> function. This function is called right before the rendered output is flushed and delivered to the browser.</p><p>I mentioned above that the page must be eligible to be cached. Even with page caching enabled, Drupal may prevent some pages from being cached. An example is a page that displays a dynamic message, like when a user doesn&rsquo;t fill out a form properly and validation errors are displayed. You wouldn&rsquo;t want that message to be part of the cached page result.</p><p>Also of note, there&rsquo;s a useful function <a href=https://api.drupal.org/api/drupal/includes%21bootstrap.inc/function/drupal_page_is_cacheable/7>drupal_page_is_cacheable</a> that can be used to instruct Drupal NOT to cache the page it was called on.</p><h2 id=how-drupal-serves-cached-pages>How Drupal serves cached pages
<a class=heading-link href=#how-drupal-serves-cached-pages><i class="fa fa-link" aria-hidden=true></i></a></h2><p>Now let&rsquo;s say the user reloads that page that was just generated and cached. Drupal again kicks off the full bootstrap process, but this time things are different because of the second phase of the bootstrap: <code>DRUPAL_BOOTSTRAP_PAGE_CACHE</code>. This phase is used to determine if a cached page can be delivered to the user, and if so, output it directly. The code is simple to follow. Checks are made to see that:</p><ul><li>The user has no Drupal session cookie (therefore, user is &ldquo;anonymous&rdquo; with no dynamic data)</li><li>Page caching is actually enabled</li><li>A page cache entry exists for the requested page</li></ul><p>If all three conditions are met, then Drupal loads the cached data out of the cache store using <a href=https://api.drupal.org/api/drupal/includes!bootstrap.inc/function/drupal_page_get_cache/7>drupal_page_get_cache</a>, outputs it, and <strong>exits out of the bootstrap process early</strong>.</p><p>It&rsquo;s worth noting that under normal circumstances, two additional phases are loaded before Drupal can serve the page cache (thanks Mark Pavlitski for the heads up): <code>DRUPAL_BOOTSTRAP_DATABASE</code> and <code>DRUPAL_BOOTSTRAP_VARIABLES</code>. The database phase is needed so Drupal knows how to access the cache, which by default is stored in the database. The variables phase will load all the settings in the variables table and load the &ldquo;bootstrap&rdquo; modules (see next section for more info on that).</p><p>Alternative cache implementations (like <a href=https://drupal.org/project/memcache>memcache</a>) don&rsquo;t typically need the database for anything when serving a cached page. You can explicitly tell Drupal to skip loading up the database and system variables by setting <code>page_cache_without_database</code> to false in the settings.php file to make responses even faster. Note that since the &ldquo;bootstrap&rdquo; modules are not loaded when this setting is enabled, you can&rsquo;t use the hooks discussed below. Everything has a trade off when it comes to performance.</p><h2 id=two-hooks-you-can-count-on>Two hooks you can count on
<a class=heading-link href=#two-hooks-you-can-count-on><i class="fa fa-link" aria-hidden=true></i></a></h2><p>Since the cache delivery happens almost immediately and early in the bootstrap process, most of Drupal&rsquo;s core API and modules are not loaded at all. That means you cannot run any hooks that affect page output. However, there are two hooks that Drupal will execute even on cached page delivery: <a href=https://api.drupal.org/api/drupal/modules%21system%21system.api.php/function/hook_boot/7>hook_boot</a> and <a href=https://api.drupal.org/api/drupal/modules!system!system.api.php/function/hook_exit/7>hook_exit</a>.</p><p>How are any hooks executed if Drupal doesn&rsquo;t load the hooks system and modules that implement them (this happens at a later bootstrap phase)? Well, when a module implements <code>hook_boot</code> or <code>hook_exit</code>, Drupal makes note of it in the &ldquo;system&rdquo; database table when the module is enabled. These modules will be loaded on demand when the hooks are invoked in <code>DRUPAL_BOOTSTRAP_PAGE_CACHE</code>. However, the more modules that implement these hooks, the slower it is for Drupal to actual serve a cached page entry (more code = more time).</p><p>Modules can use <code>hook_boot</code> to execute any code that must run on <em>every</em> page, where as its companion <a href=https://api.drupal.org/api/drupal/modules!system!system.api.php/function/hook_init/7>hook_init</a> is invoked only when a page is first rendered (meaning not on cached pages).</p><p>Almost all of the time you&rsquo;ll want to use <code>hook_init</code>, typically for things like adding specific CSS or JS files to a page. <code>hook_exit</code> is used to execute any code after a page has already been sent to the browser and right before the php process exits.</p><p>The popular <a href=https://drupal.org/project/devel>devel</a> module uses <code>hook_boot</code> so it can ensure its profiling code is run even for cached pages. Note I previously wrote that the <a href=https://drupal.org/project/redirect>redirect</a> module implemented hook_boot, but that is incorrect. Must have been a late night when I wrote that!</p><p>Both <code>hook_boot</code> and <code>hook_exit</code> can actually be disabled on cached pages as well to provide even further performance gains for cached pages. This can be done by setting <code>page_cache_invoke_hooks</code> to false in your settings.php file. A lot of modules rely on those hooks though, so you&rsquo;d really need to understand the repercussions of turning those hooks off. In Drupal 6 you could control this on the performance settings page, but now it&rsquo;s just an override in your settings.php file.</p><h2 id=page-compression>Page compression
<a class=heading-link href=#page-compression><i class="fa fa-link" aria-hidden=true></i></a></h2><p>Once you enable page caching, Drupal will reveal an additional option on the performance page called &ldquo;Compress cached pages.&rdquo; Doing so, Drupal will first compress the rendered content using PHP&rsquo;s <code>gzencode</code> function (see <a href=https://api.drupal.org/api/drupal/includes%21common.inc/function/drupal_page_set_cache/7>drupal_page_set_cache</a>) before saving it. This reduces size of the data to store in the cache dramatically, as well as offering an additional benefit! Web browsers can accept this compressed content directly and uncompress it themselves.</p><p>Browsers that support this (just about all of them) add a header indicating as such, and Drupal will deliver the gzipped content directly to the browser. The heavy lifting of decompressing the data is left up to the resources on the users machine - which is a good thing. It reduces the load on your server (except for that first &ldquo;hit&rdquo; that must be compressed) and decreases the transfer time and bandwidth.</p><p>If page caching is disabled, Drupal won&rsquo;t compress it before delivering it, but your web server can do that if you wish. <a href=http://httpd.apache.org/docs/2.2/mod/mod_deflate.html>Apache</a> and <a href=http://wiki.nginx.org/HttpGzipModule>Nginx</a> both support this. <a href=https://groups.drupal.org/node/24318>There&rsquo;s some debate</a> about whether you should use this in conjunction with Drupal&rsquo;s compression or not. For the most part you should be okay just having Drupal handle it for you. If you are working on a site where performance is a huge concern, this is something you&rsquo;ll need to look into more yourself.</p><h2 id=performance-gains>Performance gains
<a class=heading-link href=#performance-gains><i class="fa fa-link" aria-hidden=true></i></a></h2><p>The benefits of page caching are immediately clear. Above I mentioned that a Drupal site could use around 30-50 MB of RAM just to serve one page request. While that RAM is used for only a half second or so, it severely limits the amount of traffic you can serve. If a cached page is delivered instead, you&rsquo;re looking at around 2-4 MB of RAM paired with a dramatic improvement in page response time.</p><p>You won&rsquo;t be able to use the Devel module to print out the memory usage and execution time for cached page results. That&rsquo;s because Devel has no opportunity to alter the output of a cached page (nor does any other module, as I discussed above). I wrote a blog post a while back explaining how you can <a href=http://bkosborne.com/blog/determine-php-memory-usage-anonymous-users>determine php memory usage for cached page results</a>. Check if out if you&rsquo;re interested.</p><p>Your browsers dev tools will also show the dramatic improvement in response time. To test it out, clear your page cache (in performance settings, or using drush) and then load a page with dev tools open. Note the time it took to get the page from the server. Now reload the page and look at the time again (make sure you&rsquo;re logged out). On the second request, Drupal is returning the cached page that was stored from the first request.</p><p>Of all the caching methods available in Drupal core, page caching is by far the most effective and performant. Of course it&rsquo;s of no use unless you&rsquo;re serving to &ldquo;anonymous&rdquo; logged out users, but the majority of Drupal sites are probably aimed toward static content delivery.</p><h2 id=how-and-when-the-page-cache-is-cleared>How and when the page cache is cleared
<a class=heading-link href=#how-and-when-the-page-cache-is-cleared><i class="fa fa-link" aria-hidden=true></i></a></h2><p>There&rsquo;s a Drupal function called <a href=https://api.drupal.org/api/drupal/includes%21cache.inc/function/cache_clear_all/7>cache_clear_all</a> that is used all over the place to wipe out cache entires in various &ldquo;bins&rdquo;. Here are some of the actions that trigger a call to <code>cache_clear_all</code>, clearing (among other cache bins) the page cache:</p><ul><li>A node is created/edited/deleted</li><li>A block is created/edited/deleted</li><li>A comment is created/edited/deleted</li><li>A vote is registered in a poll</li><li>User profile fields are manipulated</li><li>System theme settings are changed</li><li>Taxonomy terms/vocabularies are manipulated</li><li>Permissions for roles are changed</li><li><strong>Cron is run</strong></li></ul><p>That&rsquo;s quite a list! Why do so many actions trigger a cache clear? For the most part, it&rsquo;s because <em>Drupal doesn&rsquo;t know where your content is displayed on the site</em>. It&rsquo;s not quite intelligent enough (<a href=https://drupal.org/node/636454>but it will be in Drupal 8</a>). It makes the assumption that any one of your cached pages may include a poll, a node, a comment, a taxonomy term, etc. So any time those are changed or added, Drupal clears the entire page cache!</p><p>Here&rsquo;s a common example: Let&rsquo;s say you have a View that displays the 5 most recent news articles on your homepage. When you submit a new news article, you&rsquo;d want that list to be updated. The only way that list is updated is if you clear the page cache entry for the homepage, or else it will display stale content.</p><p>All those cache clears can be problematic for a site that sees even a small amount of updates. Whenever a cached page is wiped out Drupal has to regenerate it on the next hit. That unlucky visitor will have to wait a few seconds while the whole thing is rendered instead of the snappy cached version. To combat this, Drupal allows you to enforce a minimum amount of time a cache must be valid.</p><h2 id=minimum-cache-lifetime>Minimum cache lifetime
<a class=heading-link href=#minimum-cache-lifetime><i class="fa fa-link" aria-hidden=true></i></a></h2><p>This is a setting on the performance page and has been <a href=https://drupal.org/node/1279654>confusing users</a> for years. The minimum cache lifetime determines the <em>minimum amount of time that must pass between entire cache clears</em>. Many users misunderstand this setting to instead apply to the lifetime of individual cached entries, but it has <em>nothing</em> to do with individual entries. If you have the min set to 10 minutes, you could create a new page and have it only be cached for 1 minute before it is cleared from the cache. It doesn&rsquo;t mean that a page will be cached for 10 minutes at the minimum or automatically cleared out after 10 minutes. Nothing is broken, this is how the system is designed for better or worse.</p><p>If you don&rsquo;t have the min lifetime set (which is the default), the page cache will clear no matter what on any of those above actions (including cron!). If you do set a minimum, anytime <code>cache_clear_all</code> is called to clear the page cache, it will first set a system variable indicating the timestamp of the request. On a subsequent request to clear the page cache, Drupal compares the current time to that previous time that was recorded. If it exceeds the minimum you set, it will then clear the cache.</p><p>No matter what you do, the process is very inefficient. What this usually means is that a lot of a your visitors will be hitting non-cached pages and having a bad experience. One solution is to &ldquo;warm&rdquo; the cache after it has been cleared. You can do that by using a crawler that hits all pages on your site. You can also use <a href=https://drupal.org/project/boost>boost</a>, which has a built in crawler and more advanced cache logic. Sites with serious traffic will probably use a reverse HTTP proxy like <a href=https://drupal.org/project/varnish>Varnish</a> instead of Drupal&rsquo;s page caching. There&rsquo;s also the <a href=https://drupal.org/project/adbc>Alternative Database Cache</a> module that aims to correct some of these core shortcomings (thanks to Eric Peterson for authoring and bringing to my attention).</p><h2 id=expiration-of-cached-pages>Expiration of Cached Pages
<a class=heading-link href=#expiration-of-cached-pages><i class="fa fa-link" aria-hidden=true></i></a></h2><p>This other option on the performance page is more straight forward and hopefully shouldn&rsquo;t confuse people thanks to the helpful comment alongside it. At first you may think this is a way to control the maximum amount of time an individual page will be cached before Drupal forces a new rendering of it. However, the comment reads &ldquo;The maximum time an external cache can use an old version of a page.&rdquo;</p><p>This will control the HTTP response header <code>Cache-Control</code>, setting the parameter &ldquo;max-age&rdquo; to whatever value you indicated. HTTP reverse proxies like Varnish or Nginx (or a CDN like Akamai), which can provide an extra caching layer in front of Drupal, use this important header to expire cached pages in <em>their</em> cache. The setting has nothing to do with Drupal&rsquo;s internal caching mechanisms.</p><h2 id=conclusion>Conclusion
<a class=heading-link href=#conclusion><i class="fa fa-link" aria-hidden=true></i></a></h2><p>Page caching is a no-brainer for most websites. It dramatically reduces system resources consuming when serving pages and allows for you to serve much more traffic at once. A lot of the page cache settings may seem counter intuitive. It can take hours to really dig through the code and see what&rsquo;s going on and try to figure out why. Hopefully this blog post can clear up some of the confusion and give you a better understanding at what&rsquo;s happening under the hood.</p><p>I plan on writing up more on the other forms of caching in Drupal, like Views, Block, and Form caches. Stay tuned, and please comment below.</p></div><footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//bkosborne.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></section></div><footer class=footer><section class=container>©
2010 -
2024
Brian Osborne
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.9cf2dbf9b6989ef8eae941ffb4231c26d1dc026bca38f1d19fdba50177d8a9ac.js integrity="sha256-nPLb+baYnvjq6UH/tCMcJtHcAmvKOPHRn9ulAXfYqaw="></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "bd8a23ecd0e34c58a89099ab25d009a"}'></script></body></html>