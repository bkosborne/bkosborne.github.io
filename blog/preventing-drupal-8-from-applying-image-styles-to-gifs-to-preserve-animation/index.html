<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=Content-Security-Policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self'; img-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/; script-src 'self' 'unsafe-inline' https://www.google-analytics.com https://cdn.jsdelivr.net/; prefetch-src 'self'; connect-src 'self' https://www.google-analytics.com;"><meta name=author content="Brian Osborne"><meta name=description content="I&rsquo;m working on a site where the editorial staff may occasionally produce animated GIFs and place them in an article. Image styles and animated GIFs in Drupal don&rsquo;t play nice out of the box. Drupal&rsquo;s standard image processing library, GD, does not preserve GIF animation when it processes them, so any image styles applied to the image will remove the animation. The ImageMagick image processing library is capable of preserving animation, but I believe the only way is to first coalesce the GIF which dramatically increases the output size which in unacceptable for this project (my sample 200kb GIF ballooned to nearly 2mb)."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Preventing Drupal 8 from applying image styles to GIFs to preserve animation"><meta name=twitter:description content="I&rsquo;m working on a site where the editorial staff may occasionally produce animated GIFs and place them in an article. Image styles and animated GIFs in Drupal don&rsquo;t play nice out of the box. Drupal&rsquo;s standard image processing library, GD, does not preserve GIF animation when it processes them, so any image styles applied to the image will remove the animation. The ImageMagick image processing library is capable of preserving animation, but I believe the only way is to first coalesce the GIF which dramatically increases the output size which in unacceptable for this project (my sample 200kb GIF ballooned to nearly 2mb)."><meta property="og:title" content="Preventing Drupal 8 from applying image styles to GIFs to preserve animation"><meta property="og:description" content="I&rsquo;m working on a site where the editorial staff may occasionally produce animated GIFs and place them in an article. Image styles and animated GIFs in Drupal don&rsquo;t play nice out of the box. Drupal&rsquo;s standard image processing library, GD, does not preserve GIF animation when it processes them, so any image styles applied to the image will remove the animation. The ImageMagick image processing library is capable of preserving animation, but I believe the only way is to first coalesce the GIF which dramatically increases the output size which in unacceptable for this project (my sample 200kb GIF ballooned to nearly 2mb)."><meta property="og:type" content="article"><meta property="og:url" content="http://bkosborne.com/blog/preventing-drupal-8-from-applying-image-styles-to-gifs-to-preserve-animation/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-12-09T00:00:00+00:00"><meta property="article:modified_time" content="2016-12-09T00:00:00+00:00"><title>Preventing Drupal 8 from applying image styles to GIFs to preserve animation · Brian Osborne
</title><link rel=canonical href=http://bkosborne.com/blog/preventing-drupal-8-from-applying-image-styles-to-gifs-to-preserve-animation/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.d9fddbffe6f27e69985dc5fe0471cdb0e57fbf4775714bc3d847accb08f4a1f6.css integrity="sha256-2f3b/+byfmmYXcX+BHHNsOV/v0d1cUvD2Eesywj0ofY=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.002ee2378e14c7a68f1f0a53d9694ed252090987c4e768023fac694a4fc5f793.css integrity="sha256-AC7iN44Ux6aPHwpT2WlO0lIJCYfE52gCP6xpSk/F95M=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><meta name=generator content="Hugo 0.124.1"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Brian Osborne
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=http://bkosborne.com/blog/preventing-drupal-8-from-applying-image-styles-to-gifs-to-preserve-animation/>Preventing Drupal 8 from applying image styles to GIFs to preserve animation</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2016-12-09T00:00:00Z>December 9, 2016
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
3-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/drupal-planet/>Drupal Planet</a></span></div></div></header><div><p>I&rsquo;m working on a site where the editorial staff may occasionally produce animated GIFs and place them in an article. Image styles and animated GIFs in Drupal don&rsquo;t play nice out of the box. Drupal&rsquo;s standard image processing library, GD, does not preserve GIF animation when it processes them, so any image styles applied to the image will remove the animation. The ImageMagick image processing library is capable of preserving animation, but I believe the only way is to first coalesce the GIF which dramatically increases the output size which in unacceptable for this project (my sample 200kb GIF ballooned to nearly 2mb). For anyone interested in this approach anyway, the Drupal <a href=https://www.drupal.org/project/imagemagick>ImageMagick</a> contrib module has a seemingly stable alpha release, but it would require a minor patch to get it working to retain animation.</p><p>I&rsquo;m mostly interested in somehow getting Drupal to just display the original image when it&rsquo;s a GIF to prevent this problem. On this site, images are stored in an image field that&rsquo;s part of an Image <a href=https://www.drupal.org/project/media_entity>Media Bundle</a>. This media bundle supports JPEGs and PNGs as well, and those are typically uploaded in high resolution and need to have image styles applied to them. So the challenge is to use the same media bundle and display mode for GIFs, JPEGs, and PNGs, but always display the original image when rendering a GIF.</p><p>After some digging and xdebugging, I created an implementation of <a href=https://api.drupal.org/api/drupal/core!lib!Drupal!Core!Entity!entity.api.php/function/hook_entity_display_build_alter/8.2.x>hook_entity_display_build_alter</a> which lets you alter the render array used for displaying an entity in all view modes. I use this hook to <em>remove the image style</em> of the image being rendered.</p><pre><code>/**
 * Implements hook_entity_display_build_alter().
 */
function my_module_entity_display_build_alter(&amp;$build, $context) {
  $entity = $context['entity'];

  // Checks if the entity being displayed is a image media entity in the &quot;full&quot; display mode.
  // For other display modes it's OK for us to process the GIF and lose the animation.
  if ($entity-&gt;getEntityTypeId() == 'media' &amp;&amp; $entity-&gt;bundle() == 'image' &amp;&amp; $context['view_mode'] == 'full') {
    /** @var \Drupal\media_entity\Entity\Media $entity */
    if (isset($build['image'][0])) {
      $mimetype = $mimetype = $build['image'][0]['#item']-&gt;entity-&gt;filemime-&gt;value;
      $image_style = $build['image'][0]['#image_style'];
      if ($mimetype == 'image/gif' &amp;&amp; !empty($image_style)) {
        $build['image'][0]['#image_style'] = '';
      }
    }
  }
}
</code></pre><p>So now whatever image style I have configured for this display mode will still be applied to JPEGs and PNGs but will not be applied for GIFs.</p><p><strong>However, as a commenter pointed out, this would be better served as an image field formatter so you can configure it to be applied to any image field and display mode. I&rsquo;ve created a <a href=https://www.drupal.org/sandbox/bkosborne/2834511>sandbox module</a> that does just that. The code is even simpler than what I&rsquo;ve added above.</strong></p></div><footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//bkosborne.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></section></div><footer class=footer><section class=container>©
2010 -
2024
Brian Osborne
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.9cf2dbf9b6989ef8eae941ffb4231c26d1dc026bca38f1d19fdba50177d8a9ac.js integrity="sha256-nPLb+baYnvjq6UH/tCMcJtHcAmvKOPHRn9ulAXfYqaw="></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "bd8a23ecd0e34c58a89099ab25d009a"}'></script></body></html>