<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=Content-Security-Policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self'; img-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/; script-src 'self' 'unsafe-inline' https://www.google-analytics.com https://cdn.jsdelivr.net/; prefetch-src 'self'; connect-src 'self' https://www.google-analytics.com;"><meta name=author content="Brian Osborne"><meta name=description content="I recently worked on porting over a website to Drupal that had several dynamic elements throughout the site depending on the IP address of the user. Different content could be shown depending on if the user was within a local network, a larger local network, or completely outside the network.
When porting the site over, I realized that it wouldn&rsquo;t be possible to enable page caching for any page that had this dynamic content on it."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using the 'Dynamic Cache' Module to Programmatically Disable Page Caching"><meta name=twitter:description content="I recently worked on porting over a website to Drupal that had several dynamic elements throughout the site depending on the IP address of the user. Different content could be shown depending on if the user was within a local network, a larger local network, or completely outside the network.
When porting the site over, I realized that it wouldn&rsquo;t be possible to enable page caching for any page that had this dynamic content on it."><meta property="og:title" content="Using the 'Dynamic Cache' Module to Programmatically Disable Page Caching"><meta property="og:description" content="I recently worked on porting over a website to Drupal that had several dynamic elements throughout the site depending on the IP address of the user. Different content could be shown depending on if the user was within a local network, a larger local network, or completely outside the network.
When porting the site over, I realized that it wouldn&rsquo;t be possible to enable page caching for any page that had this dynamic content on it."><meta property="og:type" content="article"><meta property="og:url" content="http://bkosborne.com/blog/using-the-dynamic-cache-module-to-programmatically-disable-page-caching/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2014-02-07T00:00:00+00:00"><meta property="article:modified_time" content="2014-02-07T00:00:00+00:00"><title>Using the 'Dynamic Cache' Module to Programmatically Disable Page Caching · Brian Osborne
</title><link rel=canonical href=http://bkosborne.com/blog/using-the-dynamic-cache-module-to-programmatically-disable-page-caching/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.d9fddbffe6f27e69985dc5fe0471cdb0e57fbf4775714bc3d847accb08f4a1f6.css integrity="sha256-2f3b/+byfmmYXcX+BHHNsOV/v0d1cUvD2Eesywj0ofY=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.002ee2378e14c7a68f1f0a53d9694ed252090987c4e768023fac694a4fc5f793.css integrity="sha256-AC7iN44Ux6aPHwpT2WlO0lIJCYfE52gCP6xpSk/F95M=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><meta name=generator content="Hugo 0.124.1"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Brian Osborne
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=http://bkosborne.com/blog/using-the-dynamic-cache-module-to-programmatically-disable-page-caching/>Using the 'Dynamic Cache' Module to Programmatically Disable Page Caching</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2014-02-07T00:00:00Z>February 7, 2014
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
6-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/drupal-planet/>Drupal Planet</a></span></div></div></header><div><p>I recently worked on porting over a website to Drupal that had several dynamic elements throughout the site depending on the IP address of the user. Different content could be shown depending on if the user was within a local network, a larger local network, or completely outside the network.</p><p>When porting the site over, I realized that it wouldn&rsquo;t be possible to enable page caching for any page that had this dynamic content on it. In Drupal, standard page caching is all or nothing. If you have it enabled and a page is &ldquo;eligible&rdquo; to be cached, Drupal saves the entire output of the page and uses it for future requests for the same page (I go into much more detail about page caching <a href=/node/143>in previous blog post</a>). In my case, if I enabled it, users who hit within one of the local intranets could trigger a page cache set, and now any users outside the intranet would view that same content.</p><p>I wanted a solution that let me either differentiate cache entries per by visitor &ldquo;type&rdquo; (but not role), or to at least prevent Drupal from serving cached pages to some of the visitors when a cached page already existed. I found a solution for the latter that I&rsquo;ll describe below. But first&mldr;</p><h2 id=why-this-is-a-hard-problem>Why this is a hard problem
<a class=heading-link href=#why-this-is-a-hard-problem><i class="fa fa-link" aria-hidden=true></i></a></h2><p>I already knew I could prevent Drupal from <em>generating</em> a page cache entry using <code>drupal_page_is_cacheable(FALSE);</code>. In fact, there&rsquo;s a popular yet very simple module called <a href=https://drupal.org/project/cacheexclude>Cache Exclude</a> that uses this function and provides an admin interface to specify which pages you want to prevent from being cached.</p><p>But what if you <em>wanted</em> to cache the pages, but force <em>some</em> visitors to view the un-cached version? This is what I needed, but Drupal has no API functions to do this. Many Drupal developers know that <code>hook_boot</code> is run on every page request, even for cache hits. So why can&rsquo;t you implement the hook and tell Drupal you don&rsquo;t want to serve a cached page? The reason is because of the way Drupal bootstraps, and when it determines if it should return a cached page or not.</p><p>There&rsquo;s a whole bootstrap &ldquo;phase&rdquo; dedicated to serving a cached page called <a href=https://api.drupal.org/api/drupal/includes%21bootstrap.inc/function/_drupal_bootstrap_page_cache/7>_drupal_bootstrap_page_cache</a>. If you take a close look, you can see that Drupal doesn&rsquo;t invoke the <code>boot</code> hook until after it <em>already determined</em> it&rsquo;s going to serve a cached page. In other words, there&rsquo;s no going back at this point.</p><h2 id=enter-the-dynamic-cache-module>Enter the &ldquo;Dynamic Cache&rdquo; module
<a class=heading-link href=#enter-the-dynamic-cache-module><i class="fa fa-link" aria-hidden=true></i></a></h2><p>I came across the <a href=https://drupal.org/project/dynamic_cache>Dynamic Cache</a> module that seemed solve this problem. Once enabled, this module lets you disable serving a cached page by setting <code>$GLOBALS['conf']['cache'] = false;</code> within your own modules <code>hook_book</code> implementation - exactly what I suggested was not possible above!</p><p>So how was Dynamic Cache doing this? In summary, Dynamic Cache implements <code>hoot_boot</code>, checks if you tried to disable serving the cached page, and if so will &ldquo;hijack&rdquo; the bootstrap process to render the whole page and ignore the page cache entry that may exist. In then makes sure to &ldquo;finish&rdquo; up the request by completing the bootstrap process itself and calling <code>menu_execute_active_handler();</code> that is normally done in index.php (but no longer get executed because of the hijack).</p><p>I want to note that what Dynamic Cache is doing is pretty scary in that it&rsquo;s almost hacking core without actually modifying any core functions. This fear is actually what triggered me to explore how the Drupal bootstrap process works under the hood so I could understand if there&rsquo;d be any potential issues.</p><p>It&rsquo;s not an easy concept to understand initially, especially since for Drupal 7 you have to enable a second module called &ldquo;Dynamic Cache Bootfix&rdquo; that hijacks the bootstrap process a second time to properly finish up the request! I don&rsquo;t want to go into much more detail, but the modules code is pretty slim and I encourage developers to take a look. It will help you get a greater understanding of the bootstrap process and the obstacles this module tries to overcome.</p><p>There&rsquo;s also a <a href=http://drupal.org/node/322104>core issue</a> that is trying to address this problem of not being able to easily disable a cached page from being served. I also encourage you to read thru that to get a better understanding of what the problems are.</p><h2 id=how-i-implemented-it>How I implemented it
<a class=heading-link href=#how-i-implemented-it><i class="fa fa-link" aria-hidden=true></i></a></h2><p>In my case, I found that the majority of traffic to the site was from users outside any of the intranets, so I decided to allow them to both trigger cache entries being generated and to be served those cached page entries. For everyone else (a small % of traffic), Drupal would always ignore whatever was in the cache for that page and would also not generate a cache entry:</p><pre><code>function my_module_boot() {
  $location = _my_module_visitor_network();
  if ($location != 'world') {
    # Prevent Drupal from serving a cached page thanks to help from the Dynamic Cache module
    $GLOBALS['conf']['cache'] = false;
    # Prevent Drupal from generating a cached page (standard Drupal function)
    drupal_page_is_cacheable(FALSE);
  }
}
</code></pre><p>Note that Dynamic Cache relies on having a heavy module weight so it runs last - which allows me to disable the cache in my own <code>hook_boot</code>. Make sure you read the README that comes with the module so you set everything up properly.</p><p>Also note that I still called <code>drupal_page_is_cacheable(FALSE);</code>. Without this, Drupal may still <em>generate</em> a cached paged based on what this user saw. With my code in place, anonymous users outside the networks I was checking would both generate page cache entries and be served page cache entries. Anonymous users within the networks/intranets would never trigger a cache generation and would never be served a cached page.</p><h2 id=final-thoughts>Final Thoughts
<a class=heading-link href=#final-thoughts><i class="fa fa-link" aria-hidden=true></i></a></h2><p>Ideally, I would be able to generate separate page caches for each &ldquo;type&rdquo; of visitor I had. I think this is possibly by creating your own cache store (which is not that difficult in Drupal 7) and changing the cache ID for the page to include the visitor type. I think the <a href=https://drupal.org/project/boost>boost module</a> may also allow for this sort of thing.</p><p>For really high traffic sites, you&rsquo;re probably going to be using something like Varnish anyway - and completely disable Drupal&rsquo;s page caching mechanism. I don&rsquo;t know much about Varnish but I imagine you could put this similar type of logic in the Varnish layer and selectively let some users through and hit Drupal directly to get the dynamically generated page (especially since my check for visitor network is just based on IP address).</p><p>There you have it. Dynamic Cache is by no means an elegant module, but it gets the job done! If you&rsquo;re better informed than I and I made a mistake somewhere in this writeup, please let me know in the comments. I certainly don&rsquo;t want to spread misinformation!</p></div><footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//bkosborne.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></section></div><footer class=footer><section class=container>©
2010 -
2024
Brian Osborne
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.9cf2dbf9b6989ef8eae941ffb4231c26d1dc026bca38f1d19fdba50177d8a9ac.js integrity="sha256-nPLb+baYnvjq6UH/tCMcJtHcAmvKOPHRn9ulAXfYqaw="></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "bd8a23ecd0e34c58a89099ab25d009a"}'></script></body></html>