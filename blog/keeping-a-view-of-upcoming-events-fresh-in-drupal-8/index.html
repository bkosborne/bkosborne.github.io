<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=Content-Security-Policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self'; img-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/; script-src 'self' 'unsafe-inline' https://www.google-analytics.com https://cdn.jsdelivr.net/; prefetch-src 'self'; connect-src 'self' https://www.google-analytics.com;"><meta name=author content="Brian Osborne"><meta name=description content="Imagine you have a view that lists upcoming events on your Drupal 8 site. There&rsquo;s a date filter that filters out any event who&rsquo;s start date is less than the current date. This works great until you realize that the output of the view will be cached in one or many places (dynamic page cache, internal page cache, varnish, etc). Once it&rsquo;s cached, views doesn&rsquo;t execute the query and can&rsquo;t compare the date to the current time, so you may get older events sticking around."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Keeping a view of upcoming events fresh in Drupal 8"><meta name=twitter:description content="Imagine you have a view that lists upcoming events on your Drupal 8 site. There&rsquo;s a date filter that filters out any event who&rsquo;s start date is less than the current date. This works great until you realize that the output of the view will be cached in one or many places (dynamic page cache, internal page cache, varnish, etc). Once it&rsquo;s cached, views doesn&rsquo;t execute the query and can&rsquo;t compare the date to the current time, so you may get older events sticking around."><meta property="og:title" content="Keeping a view of upcoming events fresh in Drupal 8"><meta property="og:description" content="Imagine you have a view that lists upcoming events on your Drupal 8 site. There&rsquo;s a date filter that filters out any event who&rsquo;s start date is less than the current date. This works great until you realize that the output of the view will be cached in one or many places (dynamic page cache, internal page cache, varnish, etc). Once it&rsquo;s cached, views doesn&rsquo;t execute the query and can&rsquo;t compare the date to the current time, so you may get older events sticking around."><meta property="og:type" content="article"><meta property="og:url" content="http://bkosborne.com/blog/keeping-a-view-of-upcoming-events-fresh-in-drupal-8/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-05-18T00:00:00+00:00"><meta property="article:modified_time" content="2017-05-18T00:00:00+00:00"><title>Keeping a view of upcoming events fresh in Drupal 8 · Brian Osborne
</title><link rel=canonical href=http://bkosborne.com/blog/keeping-a-view-of-upcoming-events-fresh-in-drupal-8/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.d9fddbffe6f27e69985dc5fe0471cdb0e57fbf4775714bc3d847accb08f4a1f6.css integrity="sha256-2f3b/+byfmmYXcX+BHHNsOV/v0d1cUvD2Eesywj0ofY=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.002ee2378e14c7a68f1f0a53d9694ed252090987c4e768023fac694a4fc5f793.css integrity="sha256-AC7iN44Ux6aPHwpT2WlO0lIJCYfE52gCP6xpSk/F95M=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><meta name=generator content="Hugo 0.124.1"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Brian Osborne
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=http://bkosborne.com/blog/keeping-a-view-of-upcoming-events-fresh-in-drupal-8/>Keeping a view of upcoming events fresh in Drupal 8</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2017-05-18T00:00:00Z>May 18, 2017
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
2-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/drupal-planet/>Drupal Planet</a></span></div></div></header><div><p>Imagine you have a view that lists upcoming events on your Drupal 8 site. There&rsquo;s a date filter that filters out any event who&rsquo;s start date is less than the current date. This works great until you realize that the output of the view will be cached in one or many places (dynamic page cache, internal page cache, varnish, etc). Once it&rsquo;s cached, views doesn&rsquo;t execute the query and can&rsquo;t compare the date to the current time, so you may get older events sticking around.</p><p>One way of fixing this is to <a href=https://www.drupal.org/project/views_custom_cache_tag>assign a custom cache tag</a> to your view, and then run a cron task that purges that cache tag at least once a day, like so:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>/**
</span></span><span style=display:flex><span> * Implements hook_cron().
</span></span><span style=display:flex><span> */
</span></span><span style=display:flex><span>function YOUR_MODULE_cron() {
</span></span><span style=display:flex><span>  // Invalidate the events view cache tag if we haven&#39;t done so today.
</span></span><span style=display:flex><span>  // This is done so that the events list always shows the proper &#34;start&#34;
</span></span><span style=display:flex><span>  // date of today when it&#39;s rendered. If we didn&#39;t do this, then it&#39;s possible
</span></span><span style=display:flex><span>  // that events from previous days could be shown.
</span></span><span style=display:flex><span>  // This relies on us setting a custom cache tag &#34;public_events_block&#34; on the
</span></span><span style=display:flex><span>  // view that lists the events via the views_custom_cache_tag module.
</span></span><span style=display:flex><span>  $state_key = &#39;events_view_last_cleared&#39;;
</span></span><span style=display:flex><span>  $last_cleared = \Drupal::state()-&gt;get($state_key);
</span></span><span style=display:flex><span>  $today = date(&#39;Y-m-d&#39;);
</span></span><span style=display:flex><span>  if ($last_cleared != $today) {
</span></span><span style=display:flex><span>    \Drupal::state()-&gt;set($state_key, $today);
</span></span><span style=display:flex><span>    \Drupal::service(&#39;cache_tags.invalidator&#39;)-&gt;invalidateTags([&#39;public_events_block&#39;]);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Assuming you have cron running just after midnight, this will refresh the cache of the view&rsquo;s block and the page at an appropriate time so that events from the previous day are not shown.</p></div><footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//bkosborne.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></section></div><footer class=footer><section class=container>©
2010 -
2024
Brian Osborne
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.9cf2dbf9b6989ef8eae941ffb4231c26d1dc026bca38f1d19fdba50177d8a9ac.js integrity="sha256-nPLb+baYnvjq6UH/tCMcJtHcAmvKOPHRn9ulAXfYqaw="></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "bd8a23ecd0e34c58a89099ab25d009a"}'></script></body></html>